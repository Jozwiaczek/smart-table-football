\chapter{Backend}
\label{ch:funplenop}
W tym rozdziale zostaną przedstawione technologie oraz rozwiązania programistyczne z obaszru logiki biznesowej w systemie, przyjęte konkretnie w pakietach 'api', 'table' oraz 'table-manger'.

\section{Node.js}

Wykorzystywany język JavaScript bezpośrednio nie oferuje komunikacji między systemem a aplikacją, jego powszechne środowisko uruchmieniowe to przeglądarka. Założeniami natomiast omawianej pracy było międzyinnymi stworzenie serwerów. W celu realizacji takiej funkcjonalności w systemie zostało zastosowane wieloplatformowe środowisko uruchomieniowe jakim jest node.js. Pozwala ono na tworzenie aplikacji w języku JavaScript, zazwyczaj są to aplikacje serwerowe, które umożliwiają swoje działanie poza przeglądarką. Tym samym Node.js udostępnia interfejs komunikacyjny z systemem, który pozwala na np. odczyt katalogów czy  zapis plików. Silnik omawianego środowiska uruchomieniowego oparty jest na silniku V8, rozwijanym przez firmę google, czyli tym samym co przeglądakra Chrome. Node.js jest bardzo dynamicznie rozwiającą się platformą, systematycznie co roku publikowana jest nowa wersja(https://nodejs.org/en/about/releases/). Omawiany projekt systemu zakłada użycie przynajmniej 12 wersji node.js (w chwili pisania pracy oficalnie aktualna wersja to 14). Poza wieloma wyżej wymienionymi zaletami systemu, wokół tej tenchologi znajduje się ogromna społeczność, która rozwija wiele dodatków oraz oferuje swoje wsparcie w interncie. Wedle ankiety z 2020 roku serwisu StackOverflow, NodeJS uzyskał pierwsze miejsce w kategorii wykorzystywanych technologii (dokładnie 51.9 procent). 
% https://insights.stackoverflow.com/survey/2020#technology-other-frameworks-libraries-and-tools-professional-developers3
% https://developer.mozilla.org/pl/docs/Learn/Server-side/Express_Nodejs/Introduction

\section{Feathers.js}
% https://feathersjs.com/
Zbudowane w systemie serwery opierają się o bibliotkę Express.js, która służy do obslugi zapytań HTTP, konfiguracji seerwerów. Całość u podstawy oparta jest własnie o powyżej opisywany Node.js. Ze względu na swoją minimalistyczność Express.js posiada wiele zintegrowanych biliotek/nakładek, które automatyzują wiele powtarzającyh się operacji oraz udostępniają zestaw narzedzi ułatwiających pracę w budowie popularnych funkcjonalności. Użytą w systemie nakładą na Express.js jest kolejna biblioteka Feathers.js. Narzedzie te zorientowane jest na budowanie aplikacji serwerowych z wykorzystaniem serwisów oraz hooków. Głównym założeniem jest zautomatyzowanie budowania aplikacji serwerowych, pozostawiajać przy tym pełną kontrolę oraz zachęcając/zapewniając dobre praktyki oprogramowania. Serwisy są obiektami reprezentujacymi predefiniowane zestawy metod CRUD (Stwórz, Wylistuj, Zzaktualizuj, Usuń). Hooki zaś są wartwą pośrednią serwisów. Umożlwiają one wpięcie się w cykl życia pojedynczych metod serwisów (przed, po i na błąd podczas ich wykonwania) oraz na wykonwyanie zdefiniowanych ciągów metod w tych wybranych etapach. 

Podczas budowy pakietu 'api' został wykorzystany również mechanizm tej bilioteki do autogenerowania początkowej z  konfiguracji aplikacji oraz generowania serwisów i hooków na podstawie zbudowanej struktury.

Kolejną bardzo istotną funkcjonalnością feathers.js zdefiniowaną w systemie jest adapter bazy danych 'feathers-mongose' oraz '@feathersjs/authentication', mechanizm autentykacji. Adapter bazy danych 'feathers-mongose' pozwala na prostą konfiguracje aplikacji działającej z bazą danych mongodb oraz deklaracje wykorzystywanych modeli opisujących strukture danych. Natomiast mechanizm autentykacji to dodatek oferujący narzedzia służące tworzeniu mechanizmu autentykacji. W systemie został użyty do utworzenia autentykacji ze startegią JWT (JavaScript Web Token) z algorytmem haszowania 'HS256'. 

Łącząc te wszystkie funkcjonalności Feathers.js końcowo zwraca zestaw zabezpieczonych mechanizmem autentykacji endpointów w architekturze REST (Representail State Transfer), umożliwiając w ten sposób pozostałym aplikacją na operacje serwerowe i bazodanowe.

\section{MongoDB}
% https://www.mongodb.com
Wybraną w projekcie bazą danych jest MongoDB. Jest to rodzaj nierelacyjnej bazy danych, w którym to strukturę określa się za pomocą schematów. Podczas tego wyboru rozważna była również baza relacyjna, która w efekcie końcowym mogłaby zapewnić większą integralność danych oraz kontrolę schematów i relacji. Mimo zalet baz relacyjnych, istotną kwestią na rozmiar projektu było utrzymanie całej struktury w jak najbardziej zunifikowanej formie. Dzięki podejściu jakie oferują nierelacyjne bazy danych struktura bazy danych została określna przy pomocy schmatów napisanych w jęzku JavaScript (w pakiecie 'api'). Kolejną bardzo ważną cechą MonoDB była możliwość dynamicznego skalowania bazy danych. Dzięki temu struktura bazy może być rozwijana i poprawiana w prosty i przejrzysty sposób.

% https://mongoosejs.com
Do określenia wspomnianych schematów i zamodelowania danych został zastosowany pakiet mongoose. Pakiet ten umożliwia budowanie struktury bazy danych w podejściu 'Code as a infrastructure' (Kod jako infrastruktura), co dla projektu oznacza budowanie infrastruktury w jednym miejscu razem z serwerem i jej kontrolę wersji wspólnie z resztą systemu. Wszystkie struktury/modele w projekcie zostały zaimplementowane w folderze 'packages/api/src/models'.

Implementacja i konfiguracja bazdy danych została zaimplementowana przy użyciu paczki 'mongoose' i zrealizowana została w pliku mongoose.js w pakiecie api. Dodatkową paczką, która została zainstalowana w celu integeracji z Feathers.js była 'feathers-mongose'. Umożliwia ona tworzenie zintegrowanych serwisów z podanymi w argumentach modelami mongodb.

\section{Socket.io}
W celu implementacji funkcjonalności realizowanych w czasie rzeczywistym jak na przykład widok gry użytkownika, została zaimplementowana paczka Socket.io. Pakiet ten u podstawy korzysta z protokółu komunikacji websockets, lecz nie jest jego bezpośrednią formą implementacji. Głównymi funkcjonalnościami paczki jakie zostały zastosowane w budowie systemu oraz odróżniającymi ją od jej podstawy (websocket) jest prosta komunikacja na podstawie wydarzeń, 'broadcasting' (wysyłanie wiadomości do wszystkich oprócz siebie) oraz intuicyjna integracje z biblioteką Feathers.js.

\section{Docker}
W celu uniknięcia skomplikowanego i zróżnicowanego sposobu (dla wielu środowisk uruchomieniowych) konfiguracji początkowej bazy danych, zostało zastosowne narzędzie konteneryzacji jakim jest Docker. Dzięki temu narzędziu lokalna praca z projektem wymaga jedynie uruchomienia aplikacji Dockera oraz wpisaniu trzech krótkich komend w terminalu, a całość konfigurowana jest już w sposób automatyczny. Po uruchomieniu wsponianych komend (opisanych w Rozdziale Aplikacja), inicjalizowana jest baza danych MongoDB w lokalnym kontenerze aplikacji docker.

\section{GoogleDrive}
Ze względu na maksymalny rozmiar pojdyńczego dokumentu w bazie danych MongoDb jaki wynosi 16MB, do przechowywania powtórek strzelonych goli zastosowano zewnętrzny serwis Google Drive. Serwis ten został wybrany ze względu na nielimitowaną ilość dostępnego miejsca na przechowywanie plików autora. Każdy plik wideo zapisywany jest w tym serwisie po strzelonym golu. Dostęp do tego pliku i jego wyświetlenia uzyskiwany jest po jednoczesnym zapisywaniu linku w bazie danych przypisanego do instacji strzelonego gola.

\section{OnOff - obsługa GPIO}
Do obsługi podstawowej funkcjonalności minikomputera Raspberry pi GPIO (Rozdział 5 - Hardware - Raspberry), została zastosowana biblioteka 'OnOff'. Umożliwia ona dostęp oraz zarządzanie sensorami, czujnikami oraz wszelkimi urządzeniami wejścia/wyjścia podłaczonymi do Raspberry poprzez GPIO. Jej implementacja oparata jest o język JavaScript i środowisko uruchomieniowe Node.js. Użycie tej biblioteki pozowliło na intuicyjne oraz proste obsługę czujników bramek oraz diod sygnalizujących stan meczu.

Przykładowa implemetnacja uruchomienia diody sygnalizującej stan meczu:

\begin{lstlisting}[breaklines=true]
    const { Gpio } = require('onoff');

    const MATCH_LIGHT = new Gpio(15, 'out');

    MATCH_LIGHT.writeSync(1);
\end{lstlisting}

\section{System mailngowy}
System w swojej budowie wykorzystuje funkcjonalność maillingu na potrzeby bezpieczeństwa kont użytkowników oraz dla większej interaktywności. System automatycznie wysła maile podczas rejestracji użytkownika do potwierdzenia maila oraz podczas akcji resetowania hasła konta użytkownika. Innym miejscem, w którym wykorzystywana jest ta funkcjonalność jest zapraszanie nowych graczy do systemu przez zarejestrowane już osoby. Kolejną funkcjonalnością zbudowanego systemu mailinogowego jest wysyłanie maili do wybranych użytkowników systemu z poziomu panelu administratora.

W celu implementacji tej funkcjonalności zastosowany został moduł 'nodemailer' dla aplikacji Node.js w pakiecie 'api'. Moduł ten, widnieje w systemie jako zdefniowany serwis, a jego głowna definicja znajduje się w klasie (packages/api/services/mailer/mailer.class.js).

% https://ethereal.email/
Do lokalnej pracy oraz testów z system mailingowym zastosowany został zewnętrzny serwis Etheral. Dzięki temu, lokalna praca nie wymagała konfiguracji oraz korzystania z zewnętrznych serwisów maillingowych oraz wykorzystywania prawdziwych kont mailowych. Użycie tego zewnętrznego serwisu wymaga jedynie wpisania danych użytkownika w ogólnej konfiguracji serwera w pakiecie api ( Rozdział Aplikacja). Wersja produkcjna, która zaś przwiduje dostarczanie widomości mailowych realnym użytkownikom zrealizowana została przy pomocy zewnętrznego serwisu 'SendGrid', który to oferuje darmowy plan wykorzystania w podstawowej formie (Rozdział Publikacja).
